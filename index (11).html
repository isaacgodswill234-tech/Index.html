<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ProfitPath Terminal | Android Aero</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #050505; --accent: #06b6d4; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg); 
            color: #fafafa; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Fix for Android scrolling: We use a standard overflow-y on the body 
           and fix the header/nav to prevent 'jumping' */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(5,5,5,0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 20px 24px;
        }

        .fixed-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 85px;
            background: rgba(5,5,5,0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .main-content {
            padding-top: 100px;
            padding-bottom: 120px;
            min-height: 100vh;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(8px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
        }
        
        /* Log tray doesn't hijack page scroll */
        .log-tray {
            height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 24px;
            padding: 16px;
        }

        input, textarea {
            font-size: 16px !important; /* Prevents iOS/Android auto-zoom on focus */
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "@google/genai": "https://esm.sh/@google/genai@1.34.0"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";

        const tg = {
            call: async (token, method, body = {}) => {
                try {
                    const resp = await fetch(`https://api.telegram.org/bot${token}/${method}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    return await resp.json();
                } catch (e) {
                    return { ok: false, description: "Connection Failed" };
                }
            }
        };

        const App = () => {
            const [tab, setTab] = useState('home');
            const [tgToken, setTgToken] = useState(() => localStorage.getItem('pp_tg_token') || '');
            const [geminiKey, setGeminiKey] = useState(() => localStorage.getItem('pp_gemini_key') || '');
            const [botInfo, setBotInfo] = useState(null);
            const [query, setQuery] = useState('Service arbitrage gaps 2025');
            const [loading, setLoading] = useState(false);
            const [opportunity, setOpportunity] = useState(null);
            const [targets, setTargets] = useState(() => JSON.parse(localStorage.getItem('pp_tg_targets') || '[]'));
            const [logs, setLogs] = useState([]);
            const [isBusy, setIsBusy] = useState(false);
            const [progress, setProgress] = useState(0);
            
            const logContainerRef = useRef(null);

            // Nexus States
            const [transmissionMode, setTransmissionMode] = useState(() => localStorage.getItem('pp_tx_mode') || 'direct');
            const [msgContent, setMsgContent] = useState('');
            const [universalLink, setUniversalLink] = useState(() => localStorage.getItem('pp_universal_link') || '');
            const [manualSourceId, setManualSourceId] = useState(() => localStorage.getItem('pp_source_id') || '');
            const [manualId, setManualId] = useState('');

            // Better Universal Parser
            const parsedData = useMemo(() => {
                if (!universalLink.trim()) return { chatId: manualSourceId, msgId: '' };
                try {
                    let clean = universalLink.trim();
                    if (clean.includes('t.me/')) {
                        const path = clean.split('t.me/')[1];
                        const parts = path.split('/').filter(Boolean);
                        if (parts[0] === 'c' && parts.length >= 2) {
                            return { chatId: `-100${parts[1]}`, msgId: parts[2] || '' };
                        } else if (parts.length >= 1) {
                            return { chatId: `@${parts[0]}`, msgId: parts[1] || '' };
                        }
                    }
                } catch (e) {}
                return { chatId: manualSourceId, msgId: universalLink.match(/\d+/)?.[0] || '' };
            }, [universalLink, manualSourceId]);

            useEffect(() => {
                localStorage.setItem('pp_tg_token', tgToken);
                localStorage.setItem('pp_gemini_key', geminiKey);
                localStorage.setItem('pp_tg_targets', JSON.stringify(targets));
                localStorage.setItem('pp_tx_mode', transmissionMode);
                localStorage.setItem('pp_source_id', manualSourceId);
                localStorage.setItem('pp_universal_link', universalLink);
            }, [tgToken, geminiKey, targets, transmissionMode, manualSourceId, universalLink]);

            useEffect(() => {
                if (tgToken.includes(':')) {
                    tg.call(tgToken, 'getMe').then(r => setBotInfo(r.ok ? r.result : null));
                }
            }, [tgToken]);

            // Isolated scrolling for logs
            useEffect(() => {
                if (logContainerRef.current) {
                    const el = logContainerRef.current;
                    el.scrollTop = el.scrollHeight;
                }
            }, [logs]);

            const addLog = (target, status, msg) => {
                setLogs(prev => [...prev, { 
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }), 
                    target, status, msg 
                }].slice(-100));
            };

            const deepSync = async () => {
                if (!tgToken) return alert("Bot Token Required.");
                addLog('System', 'info', 'Scanning incoming packets...');
                const res = await tg.call(tgToken, 'getUpdates', { limit: 100, allowed_updates: ["message", "channel_post", "my_chat_member"] });
                if (res.ok) {
                    const newTargets = [...targets];
                    let count = 0;
                    res.result.forEach((u) => {
                        const chat = u.message?.chat || u.channel_post?.chat || u.my_chat_member?.chat;
                        if (chat && !newTargets.some(t => t.id.toString() === chat.id.toString())) {
                            newTargets.push({ id: chat.id.toString(), title: chat.title || chat.username || chat.id, selected: true, type: chat.type });
                            count++;
                        }
                    });
                    setTargets(newTargets);
                    addLog('Nexus', 'ok', `Sync finished. +${count} targets.`);
                } else {
                    addLog('Nexus', 'err', "Updates blocked. Is Webhook on?");
                }
            };

            const broadcast = async () => {
                const active = targets.filter(t => t.selected);
                if (!active.length) return alert("Select target nodes.");
                if (transmissionMode === 'forward' && (!parsedData.chatId || !parsedData.msgId)) return alert("Valid post link required.");

                setIsBusy(true);
                setProgress(0);
                addLog('Sequence', 'info', `Deploying to ${active.length} nodes...`);
                
                for (let i = 0; i < active.length; i++) {
                    const t = active[i];
                    let r;
                    if (transmissionMode === 'direct') {
                        r = await tg.call(tgToken, 'sendMessage', { chat_id: t.id, text: msgContent, parse_mode: 'HTML' });
                    } else {
                        r = await tg.call(tgToken, 'forwardMessage', { chat_id: t.id, from_chat_id: parsedData.chatId, message_id: parseInt(parsedData.msgId) });
                    }
                    if (r.ok) addLog(t.title.substring(0,10), 'ok', "Pushed");
                    else addLog(t.title.substring(0,10), 'err', r.description);
                    
                    setProgress(Math.round(((i + 1) / active.length) * 100));
                    await new Promise(res => setTimeout(res, 2100));
                }
                setIsBusy(false);
                setProgress(0);
                addLog('Sequence', 'ok', "Transmission Complete.");
            };

            const analyzeNiche = async () => {
                setLoading(true);
                try {
                    const key = geminiKey || process.env.API_KEY;
                    const ai = new GoogleGenAI({ apiKey: key });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-pro-preview',
                        contents: `persona: Truthful Venture Analyst. niche: ${query}. Goal: identify a high-margin service arbitrage. Return JSON with keys: title, truthScore (0-100), theGrind (the hard parts), blueprint, actionSteps (array).`,
                        config: { tools: [{ googleSearch: {} }], responseMimeType: 'application/json' }
                    });
                    setOpportunity(JSON.parse(response.text));
                } catch (e) {
                    alert("Analysis Failed. Check Key.");
                }
                setLoading(false);
            };

            return (
                <div>
                    <header className="fixed-header">
                        <div className="flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl font-black tracking-tighter text-white">ProfitPath</h1>
                                <p className="text-[8px] font-black uppercase text-cyan-500/60 tracking-[0.3em]">Android Stability v9.0</p>
                            </div>
                            <div className={`px-4 py-1.5 rounded-full text-[9px] font-black uppercase border ${botInfo ? 'bg-cyan-500/10 border-cyan-500/20 text-cyan-400' : 'bg-red-500/10 border-red-500/20 text-red-500'}`}>
                                {botInfo ? `@${botInfo.username}` : 'Offline'}
                            </div>
                        </div>
                    </header>

                    {isBusy && (
                        <div className="fixed top-0 left-0 right-0 h-1 bg-white/5 z-[200]">
                            <div className="h-full bg-cyan-500 shadow-[0_0_10px_cyan]" style={{ width: `${progress}%` }} />
                        </div>
                    )}

                    <main className="main-content px-6 space-y-8 max-w-lg mx-auto">
                        
                        {tab === 'home' && (
                            <div className="space-y-6 animate-in">
                                <div className="bg-[#111] p-6 rounded-[32px] border border-white/5 space-y-4">
                                    <input 
                                        value={query} onChange={e => setQuery(e.target.value)}
                                        placeholder="Market niche..." 
                                        className="w-full bg-black/40 border border-white/5 rounded-2xl py-4 px-6 text-sm outline-none focus:border-cyan-500/50" 
                                    />
                                    <button 
                                        onClick={analyzeNiche} disabled={loading}
                                        className="w-full bg-cyan-500 py-4 rounded-2xl text-black font-black uppercase text-xs shadow-lg active:scale-95 transition-all"
                                    >
                                        {loading ? 'Consulting Gemini...' : 'Analyze Market'}
                                    </button>
                                </div>

                                {opportunity && (
                                    <div className="bg-[#111] rounded-[32px] p-8 border border-white/5 space-y-6">
                                        <div className="flex justify-between items-start">
                                            <h3 className="text-xl font-black text-white">{opportunity.title}</h3>
                                            <div className="text-cyan-400 font-black text-xl">{opportunity.truthScore}%</div>
                                        </div>
                                        <div className="p-4 bg-red-500/5 rounded-2xl border border-red-500/10">
                                            <p className="text-[10px] text-red-400 font-black uppercase mb-1">Truth Check</p>
                                            <p className="text-xs text-gray-400 italic leading-relaxed">"{opportunity.theGrind}"</p>
                                        </div>
                                        <div className="space-y-3">
                                            {opportunity.actionSteps?.map((s, i) => (
                                                <div key={i} className="flex gap-4">
                                                    <span className="text-cyan-500 font-black text-[10px] pt-1">{i+1}.</span>
                                                    <p className="text-xs text-gray-300 leading-relaxed">{s}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {tab === 'nexus' && (
                            <div className="space-y-6 animate-in">
                                {/* Truth & Permissions Box */}
                                <div className="bg-cyan-500/5 border border-cyan-500/20 p-5 rounded-3xl space-y-2">
                                    <h4 className="text-[10px] font-black text-cyan-400 uppercase tracking-widest">Bot Membership Truth</h4>
                                    <p className="text-[10px] text-gray-400 leading-relaxed font-medium">
                                        Bots cannot "search and join" groups. You must manually add your bot to the group or share the invite link. 
                                        If it fails, the group admin has disabled bot invites for regular members.
                                    </p>
                                </div>

                                <div className="bg-[#111] p-1.5 rounded-[24px] flex border border-white/5">
                                    <button onClick={() => setTransmissionMode('direct')} className={`flex-1 py-3 rounded-[20px] text-[9px] font-black uppercase tracking-widest transition-all ${transmissionMode === 'direct' ? 'bg-cyan-500 text-black shadow-lg' : 'text-gray-500'}`}>Direct</button>
                                    <button onClick={() => setTransmissionMode('forward')} className={`flex-1 py-3 rounded-[20px] text-[9px] font-black uppercase tracking-widest transition-all ${transmissionMode === 'forward' ? 'bg-cyan-500 text-black shadow-lg' : 'text-gray-500'}`}>Mirror</button>
                                </div>

                                <div className="bg-[#111] rounded-[32px] p-6 border border-white/5 space-y-4">
                                    <div className="flex items-center justify-between px-2">
                                        <h4 className="text-[9px] font-black text-gray-600 uppercase tracking-widest">Target Nodes ({targets.length})</h4>
                                        <button onClick={deepSync} className="text-[9px] font-black text-cyan-400 uppercase">Sync Bot</button>
                                    </div>
                                    <div className="flex gap-2">
                                        <input value={manualId} onChange={e => setManualId(e.target.value)} placeholder="Group ID..." className="flex-1 bg-black/40 border border-white/5 p-4 rounded-xl text-xs font-mono outline-none" />
                                        <button onClick={async () => {
                                            if (!manualId.trim()) return;
                                            const res = await tg.call(tgToken, 'getChat', { chat_id: manualId });
                                            if (res.ok) { setTargets(prev => [{ id: manualId, title: res.result.title || manualId, selected: true, type: res.result.type }, ...prev]); setManualId(''); }
                                            else alert("Bot must be in the chat first!");
                                        }} className="bg-white/5 px-4 rounded-xl text-[9px] font-black uppercase border border-white/10">Add</button>
                                    </div>
                                    <div className="max-h-48 overflow-y-auto space-y-2 custom-scrollbar">
                                        {targets.map(t => (
                                            <div key={t.id} onClick={() => setTargets(prev => prev.map(x => x.id === t.id ? {...x, selected: !x.selected} : x))} className={`p-4 rounded-2xl border transition-all flex items-center justify-between cursor-pointer ${t.selected ? 'border-cyan-500/40 bg-cyan-500/5 text-cyan-400' : 'border-white/5 bg-white/[0.01] text-gray-700 opacity-60'}`}>
                                                <p className="text-xs font-bold truncate pr-4">{t.title}</p>
                                                <div className={`w-3 h-3 rounded-full border transition-all ${t.selected ? 'bg-cyan-500 border-cyan-500 shadow-[0_0_8px_cyan]' : 'border-white/10'}`}></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {transmissionMode === 'direct' ? (
                                    <textarea value={msgContent} onChange={e => setMsgContent(e.target.value)} placeholder="Payload content (HTML supported)..." className="w-full bg-[#111] border border-white/5 p-6 h-36 rounded-[32px] text-xs font-medium outline-none focus:border-cyan-500/50 resize-none" />
                                ) : (
                                    <div className="bg-[#111] p-6 rounded-[32px] border border-white/5 space-y-4">
                                        <input value={universalLink} onChange={e => setUniversalLink(e.target.value)} placeholder="t.me/channel/123" className="w-full bg-black/40 border border-white/5 p-4 rounded-2xl text-xs outline-none" />
                                        <div className="flex gap-4 items-center bg-black/40 p-4 rounded-2xl border border-white/[0.03]">
                                            <div className="flex-1 overflow-hidden">
                                                <p className="text-[8px] text-gray-600 uppercase font-black mb-1">Source</p>
                                                <p className="text-[10px] font-black text-cyan-500 truncate">{parsedData.chatId || "---"}</p>
                                            </div>
                                            <div className="flex-1">
                                                <p className="text-[8px] text-gray-600 uppercase font-black mb-1">Post ID</p>
                                                <p className="text-[10px] font-black text-cyan-500">{parsedData.msgId || "---"}</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <button onClick={broadcast} disabled={isBusy} className="w-full py-5 rounded-[28px] font-black uppercase text-xs tracking-widest bg-white text-black active:scale-[0.96] transition-all">
                                    {isBusy ? 'Transmitting...' : `Push to ${targets.filter(t => t.selected).length} Targets`}
                                </button>

                                {/* Telemetry Window - Isolated scroll */}
                                <div className="log-tray">
                                    <div className="flex justify-between items-center mb-4 sticky top-0 bg-[#111]/80 backdrop-blur pb-2">
                                        <span className="text-gray-500 font-black uppercase tracking-widest text-[9px]">Telemetry</span>
                                        <button onClick={() => setLogs([])} className="text-[8px] text-red-500/60 font-black uppercase">Clear</button>
                                    </div>
                                    <div ref={logContainerRef} className="space-y-1 font-mono text-[9px]">
                                        {logs.map((l, i) => (
                                            <div key={i} className="flex gap-3 border-b border-white/[0.02] pb-1">
                                                <span className="text-gray-700">{l.time}</span>
                                                <span className="text-cyan-600 font-bold uppercase w-16 truncate">{l.target}</span>
                                                <span className={`${l.status === 'ok' ? 'text-green-500' : 'text-red-500'}`}>{l.msg}</span>
                                            </div>
                                        ))}
                                        {logs.length === 0 && <div className="text-center py-4 text-gray-700 italic">Idle.</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {tab === 'settings' && (
                            <div className="space-y-6 animate-in">
                                <div className="bg-[#111] p-8 rounded-[32px] border border-white/5 space-y-6">
                                    <h2 className="text-[10px] font-black uppercase text-cyan-500 tracking-[0.4em]">Vault</h2>
                                    <div className="space-y-4">
                                        <input type="password" value={geminiKey} onChange={e => setGeminiKey(e.target.value)} placeholder="Gemini API Key" className="w-full bg-black/40 border border-white/5 p-4 rounded-2xl text-xs outline-none focus:border-cyan-500/40" />
                                        <input type="password" value={tgToken} onChange={e => setTgToken(e.target.value)} placeholder="Telegram Bot Token" className="w-full bg-black/40 border border-white/5 p-4 rounded-2xl text-xs outline-none focus:border-cyan-500/40" />
                                    </div>
                                    <div className="pt-4 border-t border-white/5 space-y-4">
                                        <button 
                                            onClick={() => {
                                                if(!botInfo) return alert("Add Token First.");
                                                window.open(`https://t.me/${botInfo.username}?startgroup=true`, '_blank');
                                            }}
                                            className="w-full py-4 rounded-2xl bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 font-black uppercase text-[9px]"
                                        >
                                            Open Bot Invite Link
                                        </button>
                                        <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="w-full py-4 rounded-2xl border border-red-500/20 text-red-500/60 text-[9px] font-black uppercase">Wipe Local Memory</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed-nav">
                        {[
                            { id: 'home', label: 'Bounty', icon: 'M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z' },
                            { id: 'nexus', label: 'Nexus', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z' },
                            { id: 'settings', label: 'Vault', icon: 'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z' }
                        ].map(item => (
                            <button key={item.id} onClick={() => { setTab(item.id); window.scrollTo(0,0); }} className="flex flex-col items-center gap-1.5 transition-transform active:scale-90">
                                <div className={`w-14 h-7 flex items-center justify-center rounded-full transition-all ${tab === item.id ? 'bg-cyan-500/20' : ''}`}>
                                    <svg viewBox="0 0 24 24" className={`w-5 h-5 transition-colors ${tab === item.id ? 'fill-cyan-500' : 'fill-gray-600'}`}>
                                        <path d={item.icon} />
                                    </svg>
                                </div>
                                <span className={`text-[8px] font-black uppercase tracking-widest ${tab === item.id ? 'text-cyan-500' : 'text-gray-600'}`}>{item.label}</span>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>